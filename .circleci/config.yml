# This config was automatically generated from your source code
# Stacks detected: cicd:github-actions:.github/workflows,deps:rust:.
version: 2.1
orbs:
  docker: circleci/docker@2.8.1

commands:
  install_deps:
    description: "Install build dependencies"
    steps:
      - run:
          name: Install build deps
          command: |
            echo "deb http://deb.debian.org/debian bookworm-backports main" > /etc/apt/sources.list.d/bookworm-backports.list
            apt-get update
            apt-get install -y pkg-config libclang-dev libheif1/bookworm-backports libheif-dev/bookworm-backports

jobs:
  clippy-rust:
    docker:
      - image: rust:1.84-bookworm
    environment:
      RUSTFLAGS: "-D warnings"
    steps:
      - checkout
      - install_deps
      - restore_cache:
          key: cargo-clippy-rust-v1-{{ checksum "Cargo.lock" }}
      - run:
          name: Install Clippy
          command: rustup component add clippy
      - run:
          name: Run Clippy
          command: cargo clippy --all --all-targets
      - save_cache:
          key: cargo-clippy-rust-v1-{{ checksum "Cargo.lock" }}
          paths:
            - /usr/local/cargo
            - target

  format-rust:
    docker:
      - image: cimg/rust:1.84.0
    environment:
      RUSTFLAGS: "-D warnings"
    steps:
      - checkout
      - run:
          name: Run rustfmt
          command: |
            rustup toolchain install nightly
            cargo +nightly fmt -- --check

  test-rust:
    docker:
      - image: rust:1.84-bookworm
    steps:
      - checkout
      - install_deps
      - restore_cache:
          key: cargo-test-rust-v1-{{ checksum "Cargo.lock" }}
      - run:
          name: Install cargo-nextest
          command: curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin
      - run:
          name: Run tests
          command: cargo nextest -P ci run
      - store_test_results:
          path: target/nextest/ci
      - save_cache:
          key: cargo-test-rust-v1-{{ checksum "Cargo.lock" }}
          paths:
            - /usr/local/cargo
            - target

  docker-build-arm64:
    executor:
      name: docker/machine
      resource-class: arm.medium
    steps:
      - checkout
      - docker/check:
          arch: arm64
          docker-password: DOCKERHUB_PASSWORD
      - docker/build:
          image: ansg191/pp-tree-importer2
          tag: latest-arm64
          cache_from: ansg191/pp-tree-importer2:cache-arm64
          cache_to: ansg191/pp-tree-importer2:cache-arm64
      - docker/push:
          image: ansg191/pp-tree-importer2
          tag: latest-arm64

  docker-build-amd64:
    executor:
      name: docker/machine
      resource-class: medium
    steps:
      - checkout
      - docker/check:
          arch: amd64
          docker-password: DOCKERHUB_PASSWORD
      - docker/build:
          image: ansg191/pp-tree-importer2
          tag: latest-amd64
          cache_from: ansg191/pp-tree-importer2:cache-amd64
          cache_to: ansg191/pp-tree-importer2:cache-amd64
      - docker/push:
          image: ansg191/pp-tree-importer2
          tag: latest-amd64

  docker-build:
    executor:
      name: docker/machine
      resource-class: medium
    steps:
      - run:
          name: Create Multi-Arch Manifest
          command: |
            TAG=latest
            echo $DOCKERHUB_PASSWORD | docker login -u ansg191 --password-stdin
            docker manifest create ansg191/pp-tree-importer2:$TAG \
              --amend ansg191/pp-tree-importer2:$TAG-amd64 \
              --amend ansg191/pp-tree-importer2:$TAG-arm64
            docker manifest push ansg191/pp-tree-importer2:$TAG

workflows:
  build-and-test:
    jobs:
      - test-rust
      - clippy-rust
      - format-rust
      - docker-build-arm64
      - docker-build-amd64
      - docker-build:
          requires:
            - docker-build-arm64
            - docker-build-amd64
